#!@pathperl@
# -*- perl -*-

# This file is part of the nc2MoMLlib generator.
#    Copyright (C) 2004 Elaine Cheong
# 
# The attached "nesC" software is provided to you under the terms and
# conditions of the GNU General Public License Version 2 as published by the
# Free Software Foundation.
# 
# nesC is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with nesC; see the file COPYING.  If not, write to
# the Free Software Foundation, 59 Temple Place - Suite 330,
# Boston, MA 02111-1307, USA.

# Configuration
$prefix = "@prefix@";
$exec_prefix = "@exec_prefix@";
$NCDIR = "@libdir@/ncc";
$TOSDIR = "@TOSDIR@";
$TOSDIR = $ENV{"TOSDIR"} if defined($ENV{"TOSDIR"});

$PTINYOS_COMPONENT = "ptolemy.domains.nc.lib.NCComponent";
$PTINYOS_PREFIX = "\$CLASSPATH";

if ($#ARGV < 1) {
    &fail("Usage: nc2momllib <output directory> <input director(ies) for nesC files> <options that start with "-">");
}

# Get the name of the output directory
$outputdir = shift @ARGV;

# Get the input director(ies) and copy the rest of the arguments to @myargs
while ($temp = shift @ARGV) {
  $_ = $temp;
  if (/^(-).*/) {
    unshift @ARGV, $temp;
    last;
  } else {
    # Save the input directory
    push @inputdirs, $temp;
  }
}

# Copy the input arguments to another array.
@myargs = @ARGV;

$topfile = "${outputdir}/TOSIndex.xml";
open(TOSINDEX, ">", $topfile)
  or die "Can't open top level index file: $!";

print TOSINDEX "<entity name=\"TOSIndex\" class=\"ptolemy.moml.EntityLibrary\">\n";

while ($inputdir = shift @inputdirs) {
  openrecursive($inputdir);
}

print TOSINDEX "</entity>\n";

close(TOSINDEX);

#print STDERR "Couldn't execute ncc\n";
#exit 2;

sub fail {
    print STDERR "$_[0]\n";
    exit 2;
}

sub openrecursive {
  my $myinputdir = shift(@_);
  my $fh;
  opendir($fh, $myinputdir) or die "Could not open tinyos subdirectory: $!";

  my $entitypath = $myinputdir;
  @entitynameparts = split "\/", $entitypath;
  my $entityname = pop @entitynameparts;

  print TOSINDEX "<entity name=\"${entityname}\" class=\"ptolemy.moml.EntityLibrary\">\n";

  my @allfiles = grep !/^\.\.\z/, readdir $fh;
  foreach my $tempfile (@allfiles) {
    if ($tempfile eq ".") {
      # Make another copy of the input arguments.
      my @tempargs = @myargs;

      unshift @tempargs, "-I${myinputdir}";
      push @tempargs, "${myinputdir}";

      unshift @tempargs, "-tosdir=$TOSDIR";
      unshift @tempargs, "-fmoml-ptinyos-component=$PTINYOS_COMPONENT";
      unshift @tempargs, "-fmoml-ptinyos-prefix=$PTINYOS_PREFIX";
      unshift @tempargs, "-fmomldir=$myinputdir";
      unshift @tempargs, "-fmomllib";
      #unshift @tempargs, "-fsyntax-only";
      unshift @tempargs, "$exec_prefix/bin/ncc";

      system(@tempargs) == 0
        or warn "Warning: system(@tempargs) had errors: $!";

      if (-e "${myinputdir}/index.xml") {
        my $myprintpath = $myinputdir;
        $myprintpath =~ s/${TOSDIR}/tos/;

        print TOSINDEX "<input source=\"${myprintpath}/index.xml\"/>\n";
      }

    } elsif (-d "${myinputdir}/${tempfile}" and ($tempfile ne "CVS")) {
      openrecursive("${myinputdir}/${tempfile}");
    }
  }
  print TOSINDEX "</entity>\n";
}
