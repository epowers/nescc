#!@pathperl@
# This file is part of the nesC compiler.
#    Copyright (C) 2002 Intel Corporation
# 
# The attached "nesC" software is provided to you under the terms and
# conditions of the GNU General Public License Version 2 as published by the
# Free Software Foundation.
# 
# nesC is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with nesC; see the file COPYING.  If not, write to
# the Free Software Foundation, 59 Temple Place - Suite 330,
# Boston, MA 02111-1307, USA.

# Install a patched version of avr-as that matches the current compiler

$exe = $ARGV[0];

open GCCV, "avr-gcc 2>&1 -v |";

while (<GCCV>) {
  $version = $1 if (/^gcc version ([^ \n]+)/);
  $noavrgcc = 1 if /command not found/;
}
if ($noavrgcc) {
    print "avr-gcc not found, not building special avr-as\n";
    print "(if you are using avr-based motes, you will need to\n";
    print "recompile nesC after installing avr-gcc)\n";
    exit 0;
}
die "Could not determine avr-gcc version" if !defined($version);
$_ = $version;
$asv = "2.11.2" if /^3.[01]/ || /^2/;
$asv = "2.13.2.1" if !defined($asv);
$dirname = "gas-$asv-avr-dollar-patch";

print "Extracting patched AVR assembler from $dirname.tar.bz2\n";
print "(for avr-gcc version $version)\n";
die "Could not extract AVR assembler" if 
  system("bunzip2 -c $dirname.tar.bz2 | tar xf -");

die "Could not configure AVR assembler" if
  system("cd $dirname;./configure --target=avr");

die "Could not compile AVR assembler" if
  system("cd $dirname;make");

$asfile = "$dirname/gas/as-new$exe";
die "AVR assembler build failed" if !(-f $asfile);

die "Problem moving $asfile to current directory" unless
  rename $asfile, "as$exe";
